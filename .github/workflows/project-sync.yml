name: project-sync
on:
  issues:
    types: [opened, labeled]

permissions:
  contents: read
  issues: write
  repository-projects: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        env:
          OWNER: ${{ github.repository_owner }}   # 個人アカならこれでOK
          PROJECT_NUMBER: 1                       # ← あなたのProject番号に！
          STATUS_FIELD: Status
        with:
          script: |
            const owner = process.env.OWNER;
            const projectNumber = parseInt(process.env.PROJECT_NUMBER, 10);
            const label = context.payload.label ? context.payload.label.name : null;
            core.info(`event=${context.eventName} label=${label} issue=${context.payload.issue.number}`);

            // ラベル→Status対応
            const map = {
              "stage:research": "Research",
              "stage:summary":  "Summary",
              "stage:plan":     "Plan",
              "stage:review":   "Review",
              "stage:done":     "Done"
            };

            // ★ユーザーのProjectだけを取得（orgは一切触らない）
            const u = await github.graphql(`
              query($owner:String!, $num:Int!){
                user(login:$owner){
                  projectV2(number:$num){
                    id
                    fields(first:50){
                      nodes{
                        __typename
                        ... on ProjectV2FieldCommon { id name }
                      }
                    }
                  }
                }
              }`, { owner, num: projectNumber }
            );
            const proj = u.user?.projectV2;
            if (!proj) { core.setFailed('User Project not found. Check PROJECT_NUMBER/OWNER.'); return; }
            const projectId = proj.id;

            // アイテム追加（既に入っていてもOK）
            const issueNodeId = context.payload.issue.node_id;
            const addRes = await github.graphql(`
              mutation($projectId:ID!, $contentId:ID!){
                addProjectV2ItemById(input:{projectId:$projectId, contentId:$contentId}){ item { id } }
              }`, { projectId, contentId: issueNodeId }
            );
            const itemId = addRes.addProjectV2ItemById.item.id;

            // ラベルに応じて Status 更新
            if (label && map[label]) {
              const statusField = (proj.fields?.nodes || []).find(f => f.name === process.env.STATUS_FIELD);
              if (!statusField) { core.setFailed('Status field not found'); return; }
              const optRes = await github.graphql(`
                query($fid:ID!){
                  node(id:$fid){ ... on ProjectV2SingleSelectField { options { id name } } }
                }`, { fid: statusField.id }
              );
              const options = optRes?.node?.options || [];
              const target = options.find(o => o.name === map[label]);
              if (!target) { core.setFailed('Status option not found: ' + map[label]); return; }

              await github.graphql(`
                mutation($projectId:ID!,$itemId:ID!,$fieldId:ID!,$opt:String!){
                  updateProjectV2ItemFieldValue(input:{
                    projectId:$projectId, itemId:$itemId, fieldId:$fieldId,
                    value:{ singleSelectOptionId:$opt }
                  }){ projectV2Item { id } }
                }`, { projectId, itemId, fieldId: statusField.id, opt: target.id }
              );
              core.info('Status updated to ' + map[label]);
            } else {
              core.info('No mapped label; skipping Status update.');
            }
