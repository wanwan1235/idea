name: project-sync
on:
  issues:
    types: [opened, labeled]

permissions:
  contents: read
  issues: write
  repository-projects: write   # Projects操作に必要

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        env:
          OWNER: ${{ github.repository_owner }}   # 個人アカならそのまま
          PROJECT_NUMBER: 1                       # ← このプロジェクトURL末尾の番号に変更
          STATUS_FIELD: Status                    # Projectsのフィールド名
        with:
          script: |
            const owner = process.env.OWNER;
            const projectNumber = parseInt(process.env.PROJECT_NUMBER, 10);
            const label = context.payload.label ? context.payload.label.name : null;
            core.info(`event=${context.eventName} label=${label} issue=${context.payload.issue.number}`);

            // ラベル→Statusの対応
            const map = {
              "stage:research": "Research",
              "stage:summary":  "Summary",
              "stage:plan":     "Plan",
              "stage:review":   "Review",
              "stage:done":     "Done"
            };

            // Project取得（User/Org両対応）
            const q = await github.graphql(`
              query($owner:String!, $num:Int!){
                user(login:$owner){ projectV2(number:$num){ id fields(first:50){ nodes{ id name } } } }
                organization(login:$owner){ projectV2(number:$num){ id fields(first:50){ nodes{ id name } } } }
              }`, { owner, num: projectNumber }
            );
            const proj = (q.user && q.user.projectV2) || (q.organization && q.organization.projectV2);
            if (!proj) { core.setFailed('Project not found'); return; }
            const projectId = proj.id;
            const fields = proj.fields.nodes;

            // アイテム追加（既に入っててもOK）
            const issueNodeId = context.payload.issue.node_id;
            const added = await github.graphql(`
              mutation($projectId:ID!, $contentId:ID!){
                addProjectV2ItemById(input:{projectId:$projectId, contentId:$contentId}){ item { id } }
              }`, { projectId, contentId: issueNodeId }
            );
            const itemId = added.addProjectV2ItemById.item.id;

            // ラベルに応じて Status 更新
            if (label && map[label]) {
              const statusField = fields.find(f => f.name === process.env.STATUS_FIELD);
              if (!statusField) { core.setFailed('Status field not found'); return; }
              const optRes = await github.graphql(`
                query($fid:ID!){ node(id:$fid){ ... on ProjectV2SingleSelectField { options { id name } } } }
              `, { fid: statusField.id });
              const opt = optRes.node.options.find(o => o.name === map[label]);
              if (!opt) { core.setFailed('Status option not found: ' + map[label]); return; }
              await github.graphql(`
                mutation($projectId:ID!,$itemId:ID!,$fieldId:ID!,$opt:String!){
                  updateProjectV2ItemFieldValue(input:{
                    projectId:$projectId, itemId:$itemId, fieldId:$fieldId,
                    value:{ singleSelectOptionId:$opt }
                  }){ projectV2Item { id } }
                }`, { projectId, itemId, fieldId: statusField.id, opt: opt.id }
              );
            } else {
              core.info('No mapped label. Skipping status update.');
            }
